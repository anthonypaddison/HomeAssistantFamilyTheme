# ---------- existing sensors ----------
- sensor:
  - name: "weekday_name_lower"
    unique_id: weekday_name_lower
    state: >
      {% set days = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'] %}
      {{ days[now().weekday()] }}

- sensor:
  - name: "chores_incomplete_total"
    unique_id: chores_incomplete_total
    state: >
      {{
        states('todo.family')|int(0)
        + states('todo.anthony')|int(0)
        + states('todo.joy')|int(0)
        + states('todo.lizzie')|int(0)
        + states('todo.toby')|int(0)
      }}

- sensor:
  - name: "next_up_toby"
    unique_id: next_up_toby
    state: "{{ trigger.event.data.next_toby if trigger is defined and trigger.event.event_type == 'set_var' else states('sensor.next_up_toby') }}"
    trigger:
      - platform: event
        event_type: set_var

  - name: "next_up_lizzie"
    unique_id: next_up_lizzie
    state: "{{ trigger.event.data.next_lizzie if trigger is defined and trigger.event.event_type == 'set_var' else states('sensor.next_up_lizzie') }}"
    trigger:
      - platform: event
        event_type: set_var

# ---------- NEW: backend heartbeat monitor ----------
- binary_sensor:
  - name: backend_in_sync
    unique_id: backend_in_sync
    device_class: connectivity
    state: >-
      {% set t = states('input_text.backend_heartbeat') %}
      {% if t in ['unknown','unavailable',''] %}
        false
      {% else %}
        {{ ( now() - as_datetime(t) ).total_seconds() < 120 }}
      {% endif %}

- trigger:
    - platform: time_pattern
      seconds: "/1"     # update every second
  sensor:
    - name: "Family Clock"
      unique_id: family_clock
      state: "{{ now().strftime('%H:%M:%S') }}"
      attributes:
        date_long: "{{ now().strftime('%A, %d %B %Y') }}"   # e.g., Monday, 20 October 2025
        date_short: "{{ now().strftime('%Y-%m-%d') }}"      # e.g., 2025-10-20
