type: vertical-stack
cards:
  # View selector
  - type: entities
    show_header_toggle: false
    entities:
      - entity: input_select.calendar_view
        name: View
    card_mod:
      style: |
        :host {
          --mdc-icon-size: 0px !important;
          --state-icon-color: transparent !important;
          border-bottom-width: 0 !important;
        }
        mdc-line-ripple {
          display: none !important;
          border: none !important;
          height: 0 !important;
        }
        ha-card {
          background: transparent !important;
          box-shadow: none !important;
          border: 0 !important;
          margin: 0 !important;
          padding: 0 !important;
          --mdc-select-fill-color: transparent !important;
          --ha-select-min-width: 0px !important;
          --ha-select-height: 50% !important;
          --ha-card-border-width: 0px !important;
          --restore-card-border-width: 0px !important;
          border-bottom-width: 0 !important;
        }
        .mdc-select .mdc-select__anchor .mdc-floating-label { display: none !important; }
        .card-content { padding: 0 !important; }

  # DAY
  - type: conditional
    conditions:
      - entity: input_select.calendar_view
        state: Day
    card:
      type: custom:week-planner-card
      title: ''
      days: 1
      startingDay: today
      noCardBackground: true
      eventBackground: var(--family-cal-event-bg)
      compact: true
      showLegend: true
      legendToggle: true
      showNavigation: true
      hideDaysWithoutEvents: false
      columns:
        extraLarge: 5
        large: 5
        medium: 3
        small: 2
        extraSmall: 1
      calendars:
        - entity: calendar.family
          name: Family
          color: var(--family-color-family)
          hideInLegend: true
        - entity: calendar.family
          name: A
          color: var(--family-color-anthony)
          filter: ^(?:\(?\!Anthony\).)*$
          filterText: (?:\[\?Anthony\]?\s?\-\s?Anthony:\s?)
        - entity: calendar.family
          name: J
          color: var(--family-color-joy)
          filter: ^(?:\(?\!Joy\).)*$
          filterText: (?:\[\?Joy\]?\s?\-\s?Joy:\s?)
        - entity: calendar.family
          name: L
          color: var(--family-color-lizzie)
          filter: ^(?:\(?\!Lizzie\).)*$
          filterText: (?:\[\?Lizzie\]?\s?\-\s?Lizzie:\s?)
        - entity: calendar.family
          name: T
          color: var(--family-color-toby)
          filter: ^(?:\(?\!Toby\).)*$
          filterText: (?:\[\?Toby\]?\s?\-\s?Toby:\s?)
      card_mod:
        style: |
          /* Right-align the legend row and make color dots circular */
          ha-card .legend {
            display: flex !important;
            justify-content: flex-end !important;
            gap: 8px !important;
            flex-wrap: wrap !important;
            margin-right: 6px !important;
          }
          ha-card .legend .calendar .color {
            width: 35px !important;
            height: 35px !important;
            border-radius: 50% !important;
          }
          .container .legend ul li.hasToggle {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            width: 28px !important;
            height: 28px !important;
            border-radius: 50% !important;
            background-color: var(--legend-calendar-color) !important;
            color: white !important;
            font-weight: bold !important;
            font-size: 14px !important;
            list-style: none !important;
          }


  # WEEK
  - type: conditional
    conditions:
      - entity: input_select.calendar_view
        state: Week
    card:
      type: custom:week-planner-card
      title: ''
      days: 5
      startingDay: today
      noCardBackground: true
      eventBackground: var(--family-cal-event-bg)
      compact: true
      showLegend: true
      legendToggle: true
      showNavigation: true
      hideDaysWithoutEvents: false
      columns:
        extraLarge: 7
        large: 7
        medium: 5
        small: 3
        extraSmall: 1
      calendars:
        - entity: calendar.family
          name: Family
          color: var(--family-color-family)
          hideInLegend: true
        - entity: calendar.family
          name: A
          color: var(--family-color-anthony)
          filter: ^(?:\(?\!Anthony\).)*$
          filterText: (?:\[\?Anthony\]?\s?\-\s?Anthony:\s?)
        - entity: calendar.family
          name: J
          color: var(--family-color-joy)
          filter: ^(?:\(?\!Joy\).)*$
          filterText: (?:\[\?Joy\]?\s?\-\s?Joy:\s?)
        - entity: calendar.family
          name: L
          color: var(--family-color-lizzie)
          filter: ^(?:\(?\!Lizzie\).)*$
          filterText: (?:\[\?Lizzie\]?\s?\-\s?Lizzie:\s?)
        - entity: calendar.family
          name: T
          color: var(--family-color-toby)
          filter: ^(?:\(?\!Toby\).)*$
          filterText: (?:\[\?Toby\]?\s?\-\s?Toby:\s?)
      card_mod:
        style: |
          ha-card .legend {
            display: flex; justify-content: flex-end; gap: 8px; flex-wrap: wrap;
            margin-right: 6px;
          }
          ha-card .legend .calendar .color {
            width: 14px; height: 14px; border-radius: 50%;
          }

  # MONTH
  - type: conditional
    conditions:
      - entity: input_select.calendar_view
        state: Month
    card:
      type: custom:week-planner-card
      title: ''
      days: 30
      startingDay: today
      noCardBackground: true
      eventBackground: var(--family-cal-event-bg)
      compact: true
      showLegend: true
      legendToggle: true
      showNavigation: true
      hideDaysWithoutEvents: false
      columns:
        extraLarge: 7
        large: 7
        medium: 5
        small: 3
        extraSmall: 1
      calendars:
        - entity: calendar.family
          name: Family
          color: var(--family-color-family)
          hideInLegend: true
        - entity: calendar.family
          name: A
          color: var(--family-color-anthony)
          filter: ^(?:\(?\!Anthony\).)*$
          filterText: (?:\[\?Anthony\]?\s?\-\s?Anthony:\s?)
        - entity: calendar.family
          name: J
          color: var(--family-color-joy)
          filter: ^(?:\(?\!Joy\).)*$
          filterText: (?:\[\?Joy\]?\s?\-\s?Joy:\s?)
        - entity: calendar.family
          name: L
          color: var(--family-color-lizzie)
          filter: ^(?:\(?\!Lizzie\).)*$
          filterText: (?:\[\?Lizzie\]?\s?\-\s?Lizzie:\s?)
        - entity: calendar.family
          name: T
          color: var(--family-color-toby)
          filter: ^(?:\(?\!Toby\).)*$
          filterText: (?:\[\?Toby\]?\s?\-\s?Toby:\s?)
      card_mod:
        style: |
          ha-card .legend {
            display: flex; justify-content: flex-end; gap: 8px; flex-wrap: wrap;
            margin-right: 6px;
          }
          ha-card .legend .calendar .color {
            width: 14px; height: 14px; border-radius: 50%;
          }

  # Add Calendar Event (popup) â€“ visible on Calendar section
  - type: button
    icon: mdi:plus
    name: ''
    tap_action:
      action: fire-dom-event
      browser_mod:
        service: browser_mod.popup
      data:
        title: Add Calendar Event
        size: wide
        content:
          type: vertical-stack
          card_mod:
            style: |
              :host ha-dialog {
                --mdc-dialog-min-width: 780px;
                --mdc-dialog-max-width: 980px;
              }
              div.mdc-dialog div.mdc-dialog__scrim {
                backdrop-filter: blur(6px);
                background: rgba(0,0,0,.15);
              }
              div.mdc-dialog .mdc-dialog__surface {
                background: #FFFFFF;
                border-radius: 16px;
                border: 1px solid var(--family-cal-grid-line);
              }
          cards:
            - type: input-text
              entity: input_text.calendar_event_title
              name: Title
            - type: input-text
              entity: input_text.calendar_event_description
              name: Description
            - type: input-datetime
              entity: input_datetime.calendar_event_start
              name: Start
              with_time: true
            - type: input-datetime
              entity: input_datetime.calendar_event_end
              name: End
              with_time: true
            - type: input-boolean
              entity: input_boolean.calendar_all_day
              name: All Day
            - type: button
              name: Save Event
              icon: mdi:check
              tap_action:
                action: call-service
                service: script.add_calendar_event
              card_mod:
                style: |
                  :host { position: fixed; right: 24px; bottom: 24px; z-index: 1000; }
                  ha-card {
                    width: 64px; height: 64px;
                    border-radius: 50%;
                    background: var(--primary-color);
                    color: var(--primary-background-color);
                    box-shadow: 0 8px 18px rgba(0,0,0,.18);
                  }
                  ha-card .icon { --mdc-icon-size: 28px; }