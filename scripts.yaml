family_fab_open:
  alias: "Family: FAB open popup per active section"
  mode: parallel
  fields:
    browser_id:
      description: Browser Mod ID (use THIS via browser call)
      example: THIS
  sequence:
    - variables:
        section: "{{ states('input_select.family_section') | default('Calendar') }}"
    - choose:

        # ---- Calendar “Create Event” form ----
        - conditions: "{{ section == 'Calendar' }}"
          sequence:
            - service: browser_mod.popup
              data:
                browser_id: "{{ browser_id }}"
                title: "Add calendar event"
                size: wide
                content:
                  - name: summary
                    label: Title
                    selector: { text: null }
                  - name: start_date_time
                    label: Start
                    default: "{{ now().replace(second=0, microsecond=0).isoformat() }}"
                    selector: { datetime: null }
                  - name: end_date_time
                    label: End
                    default: "{{ (now() + timedelta(hours=1)).replace(second=0, microsecond=0).isoformat() }}"
                    selector: { datetime: null }
                  - name: calendar
                    label: Calendar
                    default: calendar.family
                    selector:
                      select:
                        mode: dropdown
                        options:
                          - { label: Family,  value: calendar.family }
                          - { label: Anthony, value: calendar.anthony }
                          - { label: Joy,     value: calendar.joy }
                          - { label: Lizzie,  value: calendar.lizzie }
                          - { label: Toby,    value: calendar.toby }
                right_button: "Create"
                right_button_action:
                  service: script.popup_create_calendar_event
                  data:
                    browser_id: THIS
                left_button: "Cancel"
                dismissable: true

        # ---- Chores “Add to-do” form ----
        - conditions: "{{ section == 'Chores' }}"
          sequence:
            - service: browser_mod.popup
              data:
                browser_id: "{{ browser_id }}"
                title: "Add chore"
                size: normal
                content:
                  - name: item
                    label: Chore
                    selector: { text: null }
                  - name: list_entity
                    label: List
                    default: todo.family
                    selector:
                      select:
                        mode: dropdown
                        options:
                          - { label: Family,  value: todo.family }
                          - { label: Anthony, value: todo.anthony }
                          - { label: Joy,     value: todo.joy }
                          - { label: Lizzie,  value: todo.lizzie }
                          - { label: Toby,    value: todo.toby }
                  - name: tags
                    label: "Tags (optional, e.g. #morning #kitchen)"
                    selector: { text: null }
                  - name: icon
                    label: Icon
                    selector:
                      select:
                        mode: dropdown
                        options:
                          - { label: "None", value: "" }
                          - { label: "🧹 Cleaning", value: "🧹" }
                          - { label: "🧺 Laundry",  value: "🧺" }
                          - { label: "🗑️ Rubbish",  value: "🗑️" }
                          - { label: "🧽 Wipe",     value: "🧽" }
                          - { label: "🧒 Kids",     value: "🧒" }
                  - name: due_date
                    label: Due date
                    selector: { date: null }
                  - name: due_today
                    label: Due today
                    selector: { boolean: null }
                right_button: "Add"
                right_button_action:
                  service: script.popup_add_todo
                  data:
                    browser_id: THIS
                left_button: "Cancel"
                dismissable: true

        # ---- Lists “Add item” form ----
        - conditions: "{{ section == 'Lists' }}"
          sequence:
            - service: browser_mod.popup
              data:
                browser_id: "{{ browser_id }}"
                title: "Add list item"
                size: normal
                content:
                  - name: item
                    label: Item
                    selector: { text: null }
                  - name: list_entity
                    label: "List (Todoist project)"
                    default: todo.family
                    selector:
                      select:
                        mode: dropdown
                        options:
                          - { label: Family,  value: todo.family }
                          - { label: Anthony, value: todo.anthony }
                          - { label: Joy,     value: todo.joy }
                          - { label: Lizzie,  value: todo.lizzie }
                          - { label: Toby,    value: todo.toby }
                right_button: "Add"
                right_button_action:
                  service: script.popup_add_todo
                  data:
                    browser_id: THIS
                left_button: "Cancel"
                dismissable: true

        # ---- Photos: hint-only popup ----
        - conditions: "{{ section == 'Photos' }}"
          sequence:
            - service: browser_mod.popup
              data:
                browser_id: "{{ browser_id }}"
                title: "Photos"
                content:
                  type: markdown
                  content: >
                    Drop images into your configured album folder for the *Local Photos* integration.
                right_button: "Close"
                dismissable: true

# ------------------------------------------------------------
# Popup helpers (now with browser_id + success toast)
# ------------------------------------------------------------

popup_create_calendar_event:
  alias: "Popup: create calendar event (from ha-form)"
  mode: queued
  fields:
    browser_id: {}
    summary: {}
    start_date_time: {}
    end_date_time: {}
    calendar: {}
  sequence:
    - variables:
        start_dt: >-
          {{ as_datetime(start_date_time) if start_date_time else now() }}
        proposed_end: >-
          {{ as_datetime(end_date_time) if end_date_time else (start_dt + timedelta(hours=1)) }}
        end_dt: >-
          {% if proposed_end <= start_dt %}
            {{ start_dt + timedelta(hours=1, seconds=1) }}
          {% else %}
            {{ proposed_end }}
          {% endif %}
    - service: calendar.create_event
      target:
        entity_id: "{{ calendar }}"
      data:
        summary: "{{ summary }}"
        start_date_time: "{{ start_dt.isoformat() }}"
        end_date_time: "{{ end_dt.isoformat() }}"
    - service: browser_mod.toast
      data:
        browser_id: "{{ browser_id }}"
        message: "Event created ✅"

popup_add_todo:
  alias: "Popup: add to-do (from ha-form)"
  mode: queued
  fields:
    browser_id: {}
    item: {}
    list_entity: {}
    tags: {}
    due_today: {}
    icon: {}
    due_date: {}
  sequence:
    - variables:
        prefix: "{{ icon if icon else '' }}"
        desc: "{{ (tags | default('')) }}"
        due: >-
          {{ now().date().isoformat() if due_today else (due_date if due_date else none) }}
        title: >-
          {{ (prefix ~ ' ' if prefix else '') ~ item }}
    - service: todo.add_item
      target: { entity_id: "{{ list_entity }}" }
      data:
        item: "{{ title }}"
        description: "{{ desc if desc else none }}"
        due_date: "{{ due if due else none }}"
    - service: browser_mod.toast
      data:
        browser_id: "{{ browser_id }}"
